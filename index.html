<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Солвер по тестированию</title>
    <link rel="stylesheet" href="css/only.css"/>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
</head>
<body>
    <div class="input_form">
        <h3>Солвер для одного из заданий экзамена по дисциплине «Тестирование»</h3>

        <p>1. Введите выражения из ифов:</p>

        <p>
            <input title="Первое выражение" class="wide" id="ex1" value="x > 3 && z < 5 || x <= 3 && y > 0"/>
            <input title="Второе выражение" class="wide" id="ex2" value="x <= 3 && y < 0 || z >= 5"/>
            <input title="Третье выражение" class="wide" id="ex3" value=""/>
        </p>

        <p><input type="button" id="go" value="2. Нажмите меня" /> <span class="small">(⌘+Enter)</span></p>

        <p class="info" id="error_msg"></p>

        <div id="results_section"> <!--style="display: none;"-->
            <p>3. Результат:</p>

            <table class="results" id="results">
                <tr class="heading">
                    <td colspan="4">Количество элементарных условий:</td>
                    <td>—</td>
                    <td colspan="3" rowspan="2">Ветвления</td>
                    <td rowspan="2">Полный набор комбинаций по MC/DC</td>
                </tr>
                <tr class="heading">
                    <td rowspan="2" style="width: 1.5em;"></td>
                    <td colspan="4">Элементарные условия</td>
                </tr>
                <tr class="heading">
                    <td class="equally_narrow expression_display">у1</td>
                    <td class="equally_narrow expression_display">у2</td>
                    <td class="equally_narrow expression_display">у3</td>
                    <td class="equally_narrow expression_display">у4</td>
                    <td class="equally_narrow">I</td>
                    <td class="equally_narrow">II</td>
                    <td class="equally_narrow">III</td>
                    <td>малафья</td>
                </tr>
            </table>

            <p>4. Если ты телочка, позвони мне ( ͡° ͜ʖ ͡°)</p>
        </div>
    </div>

    <script src="js/parse_logic.js"></script>
    <script src="js/analyze.js"></script>
    <script>
        /*
            Предположительно не будет:
                    - вложенных ифов
                    - изменения аргументов в теле функции
                    - любых типов кроме инта

            Вполне может оказаться:
                    - сравнение с числом по модулю
         */

        var solve_and_display = function() {
            var $results_section = $('#results_section');
            $results_section.hide();

            var $error_msg = $('#error_msg');

            var parsedExpressions = ['#ex1', '#ex2', '#ex3'].map(function(inputSelector) {
                var $input = $(inputSelector);

                var expression = parseExpression($input.val());

                $input.css('background-color', 'white');

                if(expression === null) {
                    $input.css('background-color', '#ffc0cb');

                    return -10;
                }
                else if(expression.hasOwnProperty('emptyExpression')) {
                    return undefined;
                }

                return expression;
            });

            console.log(parsedExpressions);

            if(parsedExpressions.indexOf(-10) !== -1) {
                $error_msg.text("Синтаксически неправильное (или неподдерживаемое) выражение");

                return;
            }

            parsedExpressions = parsedExpressions.filter(function(x) { return x!== undefined });

            if(parsedExpressions.length === 0) {
                $error_msg.text("Не введено ни одного выражения");

                return;
            }

            console.log("");

            var result = extractSimpleExpressions.apply(null, parsedExpressions);

            $error_msg.html("");

            if(result.allSimpleExprs.length !== 4) {
                $error_msg.text("Простейших выражений получилось " + result.allSimpleExprs.length
                    + ", а по числу столбцов в таблице должно быть только четыре. Либо условие"
                    + " было введено неправильно, либо я хз как такое решать");

                return;
            }

            $('table#results tr.generated').remove();

            var $expression_display_cells = $('td.expression_display');

            result.allSimpleExprs.forEach(function(expr, i) {
                $expression_display_cells.eq(i).html(printExpr(expr));
            });

            var evalValues = [];
            var evalResults = [];

            for(var i = 0; i < 16; i++) {
                var values = {};

                var iTmp = i;

                var newRow = "<tr class=\"generated row_" + i +"\"><td>" + (i + 1) +"</td>";

                result.allSimpleExprs.forEach(function(simpleExpr) {
                    values[simpleExpr] = (iTmp & 8) !== 0;

                    newRow += "<td>" + ((iTmp & 8) / 8) + "</td>";

                    iTmp <<= 1;
                });

                evalValues.push(values);

                result.bigExprs.forEach(function(bigExpr) {
                    var evalResult = evaluateExpr(bigExpr, values);

                    newRow += "<td>" + (evalResult ? 1 : 0) + "</td>";

                    evalResults.push(evalResult);
                });

                newRow += "<td></td><td></td></tr>";

                $(newRow).appendTo($('table#results'));
            }

            $results_section.show();
        };

        var submitHotkeyPressed = function(e) {
            if((e.ctrlKey || e.metaKey) && e.keyCode === 13) {
                solve_and_display();
            }
        };

        $('input.wide').keydown(submitHotkeyPressed).keyup(submitHotkeyPressed);

        $('#go').click(solve_and_display);

        solve_and_display();
    </script>
</body>
</html>
